ARG BASE_IMAGE=docker.io/rayproject/ray:2.24.0-py310

FROM ${BASE_IMAGE} AS base

# see https://docs.openshift.com/container-platform/4.17/openshift_images/create-images.html#use-uid_create-images
USER root
RUN chown ray:root /home/ray && chmod g=u /home/ray
USER ray

RUN pip install --upgrade --no-cache-dir pip

RUN pip install --no-cache-dir pytest

USER root
RUN apt -y update \
    && apt install -y clamav-daemon \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*
USER ray

FROM docker.io/clamav/clamav:latest AS clamav
FROM base AS clamav-local
USER root
COPY --chown=ray:0 --from=clamav /var/lib/clamav/ /var/lib/clamav/
COPY --chown=ray:0 clamd.conf /etc/clamav/clamd.conf
RUN freshclam \
    && mkdir -p /var/run/clamav \
    && chown -R ray:0 /var/run/clamav /var/log/clamav /var/lib/clamav \
    && chmod -R 777 /var/run/clamav /var/log/clamav /var/lib/clamav
USER ray
CMD ["/bin/bash", "-c", "clamd --debug --foreground"]

FROM base AS malware

ARG EXTRA_ARTIFACTORY_URL
ARG BUILD_DATE
ARG GIT_COMMIT

COPY --from=clamav-local --chown=ray:0 /var/lib/clamav/ /var/lib/clamav/
COPY --from=clamav-local --chown=ray:0 /etc/clamav/clamd.conf /etc/clamav/clamd.conf
COPY --from=clamav-local --chown=ray:0 /var/log/clamav /var/log/clamav
COPY --from=clamav-local --chown=ray:0 /var/run/clamav /var/run/clamav

ARG DPK_WHEEL_FILE_NAME

# Copy and install data processing libraries 
# These are expected to be placed in the docker context before this is run (see the make image).
COPY --chmod=775 --chown=ray:root data-processing-dist data-processing-dist
RUN  pip install data-processing-dist/${DPK_WHEEL_FILE_NAME}[ray]

COPY --chmod=775 --chown=ray:root python-transform/  python-transform/
RUN cd python-transform && pip install --no-cache-dir -e .

COPY --chmod=775 --chown=ray:root src/ src/
COPY --chmod=775 --chown=ray:root pyproject.toml pyproject.toml
RUN pip install --no-cache-dir -e .

# copy the main() entry point to the image 
COPY --chmod=775 --chown=ray:root src/malware_transform_ray.py  ./

# copy some of the samples in
COPY --chmod=775 --chown=ray:root src/malware_local_ray.py  local/

COPY --chmod=775 --chown=ray:root test/ test/
COPY --chmod=775 --chown=ray:root test-data/ test-data/

ENV PYTHONPATH /home/ray

USER root
RUN rm -rf /var/log/clamav && mkdir -p /var/log/clamav && chown -R ray:0 /var/log/clamav
USER ray
RUN chmod -R 777 /var/run/clamav /var/log/clamav

# Put these at the end since they seem to upset the docker cache.
LABEL build-date=$BUILD_DATE
LABEL git-commit=$GIT_COMMIT
